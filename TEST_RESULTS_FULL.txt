============================= test session starts ==============================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0 -- /Users/mendel/side_pro/OSFeed/.auto-claude/worktrees/tasks/016-fix-role-escalation-vulnerability-in-user-registra/backend/venv/bin/python
cachedir: .pytest_cache
rootdir: /Users/mendel/side_pro/OSFeed/.auto-claude/worktrees/tasks/016-fix-role-escalation-vulnerability-in-user-registra/backend
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.2.0
asyncio: mode=auto, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 183 items

tests/test_auth_email_flows.py::test_register_and_verify_flow PASSED     [  0%]
tests/test_auth_email_flows.py::test_forgot_and_reset_password_flow PASSED [  1%]
tests/test_auth_email_flows.py::test_login_blocked_for_inactive_user PASSED [  1%]
tests/test_auth_email_flows.py::test_rate_limiting_returns_429 PASSED    [  2%]
tests/test_auth_email_flows.py::test_verify_rejects_invalid_token PASSED [  2%]
tests/test_auth_email_flows.py::test_reset_password_rejects_invalid_token PASSED [  3%]
tests/test_auth_login_rate_limit.py::test_login_rate_limiting SKIPPED    [  3%]
tests/test_auth_login_rate_limit.py::test_login_rate_limiting_different_ips_are_independent SKIPPED [  4%]
tests/test_auth_logout.py::test_logout_endpoint PASSED                   [  4%]
tests/test_auth_rate_limiter_failsafe.py::test_get_auth_rate_limiter_raises_when_redis_not_configured PASSED [  5%]
tests/test_auth_rate_limiter_failsafe.py::test_check_rate_limit_returns_503_on_redis_connection_error PASSED [  6%]
tests/test_auth_rate_limiter_failsafe.py::test_login_endpoint_returns_503_when_redis_unavailable PASSED [  6%]
tests/test_auth_rate_limiter_failsafe.py::test_register_endpoint_returns_503_when_redis_unavailable PASSED [  7%]
tests/test_auth_rate_limiter_failsafe.py::test_forgot_password_endpoint_returns_503_when_redis_unavailable PASSED [  7%]
tests/test_auth_rate_limiter_failsafe.py::test_request_verify_endpoint_returns_503_when_redis_unavailable PASSED [  8%]
tests/test_auth_rate_limiter_failsafe.py::test_redis_incr_failure_returns_503 PASSED [  8%]
tests/test_auth_rate_limiter_failsafe.py::test_redis_generic_exception_returns_503 PASSED [  9%]
tests/test_auth_refresh.py::test_login_and_refresh_token_flow PASSED     [  9%]
tests/test_auth_refresh.py::test_refresh_token_rejects_invalid_token PASSED [ 10%]
tests/test_auth_registration.py::test_register_success PASSED            [ 10%]
tests/test_auth_registration.py::test_register_duplicate_email PASSED    [ 11%]
tests/test_auth_registration.py::test_forgot_password_returns_202 PASSED [ 12%]
tests/test_auth_registration.py::test_forgot_password_nonexistent_email_returns_202 PASSED [ 12%]
tests/test_auth_registration.py::test_register_weak_password_too_short PASSED [ 13%]
tests/test_auth_registration.py::test_register_weak_password_no_uppercase PASSED [ 13%]
tests/test_auth_registration.py::test_register_weak_password_no_lowercase PASSED [ 14%]
tests/test_auth_registration.py::test_register_weak_password_no_digit PASSED [ 14%]
tests/test_auth_registration.py::test_register_weak_password_no_special_char PASSED [ 15%]
tests/test_auth_registration.py::test_register_strong_password_success PASSED [ 15%]
tests/test_auth_role_escalation.py::test_register_default_role_is_viewer PASSED [ 16%]
tests/test_auth_role_escalation.py::test_register_with_admin_role_ignored PASSED [ 16%]
tests/test_auth_role_escalation.py::test_register_with_analyst_role_ignored PASSED [ 17%]
tests/test_auth_role_escalation.py::test_existing_admin_users_unaffected PASSED [ 18%]
tests/test_auth_role_escalation.py::test_register_with_superuser_flag_ignored PASSED [ 18%]
tests/test_auth_role_escalation.py::test_register_with_is_verified_flag_ignored PASSED [ 19%]
tests/test_auth_role_escalation.py::test_register_with_multiple_privilege_escalation_attempts PASSED [ 19%]
tests/test_cache_service.py::TestCacheServiceDisabled::test_get_returns_none_when_redis_disabled PASSED [ 20%]
tests/test_cache_service.py::TestCacheServiceDisabled::test_set_returns_false_when_redis_disabled PASSED [ 20%]
tests/test_cache_service.py::TestCacheServiceDisabled::test_setex_returns_false_when_redis_disabled PASSED [ 21%]
tests/test_cache_service.py::TestCacheServiceDisabled::test_delete_returns_false_when_redis_disabled PASSED [ 21%]
tests/test_cache_service.py::TestCacheServiceDisabled::test_incr_returns_zero_when_redis_disabled PASSED [ 22%]
tests/test_cache_service.py::TestCacheServiceWithMockedRedis::test_get_returns_cached_value PASSED [ 22%]
tests/test_cache_service.py::TestCacheServiceWithMockedRedis::test_get_returns_none_when_key_not_found PASSED [ 23%]
tests/test_cache_service.py::TestCacheServiceWithMockedRedis::test_set_stores_value_successfully PASSED [ 24%]
tests/test_cache_service.py::TestCacheServiceWithMockedRedis::test_setex_stores_value_with_ttl PASSED [ 24%]
tests/test_cache_service.py::TestCacheServiceWithMockedRedis::test_delete_removes_key_successfully PASSED [ 25%]
tests/test_cache_service.py::TestCacheServiceWithMockedRedis::test_incr_increments_counter PASSED [ 25%]
tests/test_cache_service.py::TestCacheServiceErrorHandling::test_get_returns_none_on_redis_error PASSED [ 26%]
tests/test_cache_service.py::TestCacheServiceErrorHandling::test_set_returns_false_on_redis_error PASSED [ 26%]
tests/test_cache_service.py::TestCacheServiceErrorHandling::test_setex_returns_false_on_redis_error PASSED [ 27%]
tests/test_cache_service.py::TestCacheServiceErrorHandling::test_delete_returns_false_on_redis_error PASSED [ 27%]
tests/test_cache_service.py::TestCacheServiceErrorHandling::test_incr_returns_zero_on_redis_error PASSED [ 28%]
tests/test_cache_service.py::TestCacheServiceConnectionManagement::test_get_redis_creates_connection_once PASSED [ 28%]
tests/test_cache_service.py::TestCacheServiceConnectionManagement::test_close_closes_redis_connection PASSED [ 29%]
tests/test_cache_service.py::TestCacheServiceConnectionManagement::test_close_does_nothing_when_no_connection PASSED [ 30%]
tests/test_cache_service.py::TestCacheServiceSingleton::test_get_cache_service_returns_same_instance PASSED [ 30%]
tests/test_cache_service.py::TestCacheServiceSingleton::test_get_cache_service_creates_cache_service_instance PASSED [ 31%]
tests/test_channel_translation_decision.py::test_should_channel_translate_homogeneous_users_returns_false PASSED [ 31%]
tests/test_channel_translation_decision.py::test_should_channel_translate_mixed_users_returns_true PASSED [ 32%]
tests/test_channel_translation_decision.py::test_should_channel_translate_no_users_returns_true PASSED [ 32%]
tests/test_channel_translation_decision.py::test_should_channel_translate_null_channel_language_returns_true PASSED [ 33%]
tests/test_channel_translation_decision.py::test_should_channel_translate_single_matching_user_returns_false PASSED [ 33%]
tests/test_channel_translation_decision.py::test_should_channel_translate_nonexistent_channel_returns_true PASSED [ 34%]
tests/test_channel_translation_decision.py::test_should_channel_translate_single_mismatched_user_returns_true PASSED [ 34%]
tests/test_channel_translation_decision.py::test_should_channel_translate_multiple_users_one_mismatch_returns_true PASSED [ 35%]
tests/test_channels_add.py::test_add_channel_success PASSED              [ 36%]
tests/test_channels_add.py::test_add_channel_with_url_prefix PASSED      [ 36%]
tests/test_channels_add.py::test_add_channel_with_at_symbol PASSED       [ 37%]
tests/test_channels_add.py::test_add_channel_invalid_username_format PASSED [ 37%]
tests/test_channels_add.py::test_add_channel_already_exists_in_list PASSED [ 38%]
tests/test_channels_add.py::test_add_channel_links_existing_channel PASSED [ 38%]
tests/test_channels_add.py::test_add_channel_telegram_error PASSED       [ 39%]
tests/test_channels_add.py::test_bulk_add_channels_success PASSED        [ 39%]
tests/test_channels_add.py::test_bulk_add_channels_partial_success PASSED [ 40%]
tests/test_channels_add.py::test_bulk_add_channels_empty_list PASSED     [ 40%]
tests/test_channels_add.py::test_bulk_add_channels_invalid_format PASSED [ 41%]
tests/test_channels_add.py::test_bulk_add_channels_with_url_prefixes PASSED [ 42%]
tests/test_channels_add.py::test_bulk_add_channels_telegram_error PASSED [ 42%]
tests/test_channels_add.py::test_add_channel_join_limit_reached PASSED   [ 43%]
tests/test_channels_refresh_flow.py::test_refresh_enqueues_jobs PASSED   [ 43%]
tests/test_channels_refresh_flow.py::test_fetch_jobs_status_returns_jobs PASSED [ 44%]
tests/test_dashboard_endpoint.py::test_dashboard_endpoint_structure PASSED [ 44%]
tests/test_dashboard_endpoint.py::test_dashboard_endpoint_uses_asyncio_gather PASSED [ 45%]
tests/test_email_service.py::TestTemplateRenderer::test_render_verification_html PASSED [ 45%]
tests/test_email_service.py::TestTemplateRenderer::test_render_password_reset_txt PASSED [ 46%]
tests/test_email_service.py::TestTemplateRenderer::test_render_missing_template_returns_fallback PASSED [ 46%]
tests/test_email_service.py::TestEmailServiceDisabled::test_send_verification_returns_false_when_disabled PASSED [ 47%]
tests/test_email_service.py::TestEmailServiceDisabled::test_send_password_reset_returns_false_when_disabled PASSED [ 48%]
tests/test_email_service.py::TestEmailServiceWithMockedProvider::test_send_verification_calls_provider PASSED [ 48%]
tests/test_email_service.py::TestEmailServiceWithMockedProvider::test_send_password_reset_calls_provider PASSED [ 49%]
tests/test_email_service.py::TestEmailServiceWithMockedProvider::test_send_verification_returns_false_on_provider_failure PASSED [ 49%]
tests/test_email_service.py::TestEmailServiceWithMockedProvider::test_build_link_includes_token PASSED [ 50%]
tests/test_email_service.py::TestProviderSelection::test_smtp_provider_selected PASSED [ 50%]
tests/test_email_service.py::TestProviderSelection::test_resend_provider_selected PASSED [ 51%]
tests/test_email_service.py::TestProviderSelection::test_unknown_provider_returns_none PASSED [ 51%]
tests/test_error_handling_security.py::test_channel_add_database_error_returns_generic_message PASSED [ 52%]
tests/test_error_handling_security.py::test_channel_add_value_error_returns_generic_message PASSED [ 53%]
tests/test_error_handling_security.py::test_bulk_channel_add_error_returns_generic_message PASSED [ 53%]
tests/test_error_handling_security.py::test_invalid_cursor_format_returns_generic_message PASSED [ 54%]
tests/test_error_handling_security.py::test_malformed_cursor_data_returns_generic_message PASSED [ 54%]
tests/test_error_handling_security.py::test_errors_are_logged_internally PASSED [ 55%]
tests/test_error_handling_security.py::test_channel_refresh_error_returns_generic_message PASSED [ 55%]
tests/test_error_handling_security.py::test_no_stack_traces_in_error_responses PASSED [ 56%]
tests/test_error_handling_security.py::test_collection_create_database_error_returns_generic_message PASSED [ 56%]
tests/test_error_handling_security.py::test_alert_create_database_error_returns_generic_message PASSED [ 57%]
tests/test_error_handling_security.py::test_auth_registration_unexpected_error_returns_generic_code PASSED [ 57%]
tests/test_error_handling_security.py::test_message_search_database_error_returns_generic_message PASSED [ 58%]
tests/test_error_handling_security.py::test_export_format_error_returns_generic_message PASSED [ 59%]
tests/test_export.py::test_export_collection_csv PASSED                  [ 59%]
tests/test_export.py::test_export_collection_html PASSED                 [ 60%]
tests/test_export_utils.py::TestMessageCSVColumns::test_csv_columns_defined PASSED [ 60%]
tests/test_export_utils.py::TestCreateCSVWriter::test_create_writer_with_default_buffer PASSED [ 61%]
tests/test_export_utils.py::TestCreateCSVWriter::test_create_writer_with_provided_buffer PASSED [ 61%]
tests/test_export_utils.py::TestCreateCSVWriter::test_writer_functionality PASSED [ 62%]
tests/test_export_utils.py::TestGenerateCSVRow::test_generate_row_with_all_fields PASSED [ 62%]
tests/test_export_utils.py::TestGenerateCSVRow::test_generate_row_with_none_values PASSED [ 63%]
tests/test_export_utils.py::TestGenerateCSVRow::test_generate_row_with_special_characters PASSED [ 63%]
tests/test_export_utils.py::TestGenerateCSVRow::test_generate_row_writes_to_csv PASSED [ 64%]
tests/test_export_utils.py::TestGenerateHTMLTemplate::test_generate_template_with_default_title PASSED [ 65%]
tests/test_export_utils.py::TestGenerateHTMLTemplate::test_generate_template_with_custom_title PASSED [ 65%]
tests/test_export_utils.py::TestGenerateHTMLTemplate::test_template_escapes_html_in_title PASSED [ 66%]
tests/test_export_utils.py::TestGenerateHTMLTemplate::test_template_includes_styles PASSED [ 66%]
tests/test_export_utils.py::TestGenerateHTMLTemplate::test_template_structure PASSED [ 67%]
tests/test_export_utils.py::TestGenerateHTMLArticle::test_generate_article_with_translated_text PASSED [ 67%]
tests/test_export_utils.py::TestGenerateHTMLArticle::test_generate_article_with_only_original_text PASSED [ 68%]
tests/test_export_utils.py::TestGenerateHTMLArticle::test_generate_article_with_only_translated_text PASSED [ 68%]
tests/test_export_utils.py::TestGenerateHTMLArticle::test_generate_article_with_empty_text PASSED [ 69%]
tests/test_export_utils.py::TestGenerateHTMLArticle::test_article_escapes_html_content PASSED [ 69%]
tests/test_export_utils.py::TestGenerateHTMLArticle::test_article_handles_special_characters PASSED [ 70%]
tests/test_export_utils.py::TestGeneratePDFBytes::test_generate_pdf_from_simple_html SKIPPED [ 71%]
tests/test_export_utils.py::TestGeneratePDFBytes::test_generate_pdf_from_complex_html SKIPPED [ 71%]
tests/test_export_utils.py::TestGeneratePDFBytes::test_generate_pdf_raises_when_weasyprint_unavailable PASSED [ 72%]
tests/test_export_utils.py::TestGeneratePDFBytes::test_generate_pdf_with_unicode_content SKIPPED [ 72%]
tests/test_health_check.py::test_health_check_success PASSED             [ 73%]
tests/test_health_check.py::test_health_check_database_failure_no_error_details PASSED [ 73%]
tests/test_health_check.py::test_health_check_query_execution_failure PASSED [ 74%]
tests/test_idor_security.py::test_get_channel_unauthorized_access PASSED [ 74%]
tests/test_idor_security.py::test_get_channel_authorized_access PASSED   [ 75%]
tests/test_idor_security.py::test_get_channel_nonexistent PASSED         [ 75%]
tests/test_idor_security.py::test_get_message_unauthorized_access PASSED [ 76%]
tests/test_idor_security.py::test_get_message_authorized_access PASSED   [ 77%]
tests/test_idor_security.py::test_get_message_nonexistent PASSED         [ 77%]
tests/test_idor_security.py::test_delete_channel_unauthorized_access PASSED [ 78%]
tests/test_idor_security.py::test_delete_channel_authorized_access PASSED [ 78%]
tests/test_idor_security.py::test_delete_channel_no_enumeration PASSED   [ 79%]
tests/test_idor_security.py::test_shared_channel_access_isolation PASSED [ 79%]
tests/test_llm_translator_cache.py::test_cache_evicts_oldest_entry PASSED [ 80%]
tests/test_llm_translator_cache.py::test_cache_lru_order PASSED          [ 80%]
tests/test_llm_translator_cache.py::test_cache_respects_max_size PASSED  [ 81%]
tests/test_llm_translator_cache.py::test_cache_hit_count_increments PASSED [ 81%]
tests/test_llm_translator_cache.py::test_cache_works_independently_per_language_pair PASSED [ 82%]
tests/test_messages_translation.py::test_translate_message_on_demand_updates_message PASSED [ 83%]
tests/test_messages_translation.py::test_stream_messages_batches PASSED  [ 83%]
tests/test_postgres_regression.py::test_postgres_schema_regression SKIPPED [ 84%]
tests/test_security_headers.py::test_security_headers_on_health_endpoint PASSED [ 84%]
tests/test_security_headers.py::test_security_headers_values PASSED      [ 85%]
tests/test_security_headers.py::test_security_headers_on_api_endpoints PASSED [ 85%]
tests/test_security_headers.py::test_security_headers_on_docs_endpoint PASSED [ 86%]
tests/test_security_headers.py::test_security_headers_on_error_responses PASSED [ 86%]
tests/test_security_headers.py::test_security_headers_on_root_endpoint PASSED [ 87%]
tests/test_security_headers.py::test_csp_prevents_unsafe_inline_by_default PASSED [ 87%]
tests/test_security_headers.py::test_csp_does_not_contain_unsafe_eval PASSED [ 88%]
tests/test_security_headers.py::test_x_frame_options_prevents_clickjacking PASSED [ 89%]
tests/test_security_headers.py::test_hsts_enforces_https PASSED          [ 89%]
tests/test_security_headers.py::test_permissions_policy_restricts_features PASSED [ 90%]
tests/test_security_headers.py::test_security_headers_can_be_disabled PASSED [ 90%]
tests/test_security_headers.py::test_custom_csp_directives PASSED        [ 91%]
tests/test_security_headers.py::test_hsts_configuration PASSED           [ 91%]
tests/test_security_headers.py::test_x_frame_options_configurable PASSED [ 92%]
tests/test_stats_overview.py::test_overview_stats_empty_database PASSED  [ 92%]
tests/test_stats_overview.py::test_overview_stats_messages_older_than_24h PASSED [ 93%]
tests/test_stats_overview.py::test_overview_stats_duplicates_within_24h PASSED [ 93%]
tests/test_stats_overview.py::test_overview_stats_user_isolation PASSED  [ 94%]
tests/test_stats_overview.py::test_overview_stats_active_vs_inactive_channels PASSED [ 95%]
tests/test_stats_overview.py::test_overview_stats_mixed_scenario PASSED  [ 95%]
tests/test_translate_batch.py::test_translate_batch_llm_splits_by_separator PASSED [ 96%]
tests/test_translate_batch.py::test_translate_batch_llm_fallback_on_mismatch PASSED [ 96%]
tests/test_translate_batch.py::test_translate_batch_preserves_order_and_skips_same_language PASSED [ 97%]
tests/test_translation_optimizations.py::test_translation_priority_skips_trivial_patterns PASSED [ 97%]
tests/test_translation_optimizations.py::test_translation_priority_same_language_skip PASSED [ 98%]
tests/test_translation_optimizations.py::test_translation_priority_by_age PASSED [ 98%]
tests/test_translation_optimizations.py::test_model_routing_fallback_to_google_when_keys_missing PASSED [ 99%]
tests/test_translation_optimizations.py::test_translate_skips_trivial_text_without_api_call PASSED [100%]

=============================== warnings summary ===============================
venv/lib/python3.9/site-packages/urllib3/__init__.py:35
  /Users/mendel/side_pro/OSFeed/.auto-claude/worktrees/tasks/016-fix-role-escalation-vulnerability-in-user-registra/backend/venv/lib/python3.9/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
    warnings.warn(

tests/test_auth_email_flows.py: 1 warning
tests/test_auth_registration.py: 8 warnings
tests/test_auth_role_escalation.py: 6 warnings
  /Users/mendel/side_pro/OSFeed/.auto-claude/worktrees/tasks/016-fix-role-escalation-vulnerability-in-user-registra/backend/app/auth/users.py:112: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    user_dict = user_create.dict() if hasattr(user_create, 'dict') else user_create.model_dump()

tests/test_health_check.py::test_health_check_database_failure_no_error_details
tests/test_health_check.py::test_health_check_query_execution_failure
  /Users/mendel/side_pro/OSFeed/.auto-claude/worktrees/tasks/016-fix-role-escalation-vulnerability-in-user-registra/backend/app/main.py:161: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    async with engine.connect() as conn:
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================= 177 passed, 6 skipped, 18 warnings in 6.21s ==================
